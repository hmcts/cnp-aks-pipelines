parameters:
  serviceConnection: ""

steps:
  - task: AzureKeyVault@1
    displayName: "Get secrets from Keyvault"
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      keyVaultName: $(keyvaultName)
      secretsFilter: "bfa-root-password,bfa-user-password"

  - template: steps/configure-helm.yaml@cnp-library
    parameters:
      serviceConnection: $(serviceConnection)

  - task: HelmDeploy@0
    displayName: "BFA - Install MongoDB"
    enabled: true
    inputs:
      connectionType: $(kubectlConnectionType)
      azureSubscription: ${{ parameters.serviceConnection }}
      azureResourceGroup: $(aksResourceGroup)
      kubernetesCluster: $(clusterName)
      command: "install"
      chartType: "Name"
      chartName: "stable/mongodb"
      namespace: "jenkins-bfa"
      releaseName: "jenkins-bfa"
      valueFile: "helm/all/mongodb.yml"
      overrideValues: "mongodbRootPassword=$(bfa-root-password),mongodbPassword=$(bfa-user-password)"
